name: CI/CD Pipeline - Electricity Theft Detection

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Nightly drift detection
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: "3.10"
  POETRY_VERSION: "1.7.1"
  MODEL_REGISTRY: "s3://utility-ml-models/electricity-theft"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pypoetry
        key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}

    - name: Install dependencies
      run: |
          poetry install --with dev,test

    - name: Download quantized SLM for testing
      run: |
        if [ -f "scripts/download_quantized_model.py" ]; then
          poetry run python scripts/download_quantized_model.py --model phi-3-mini
        else
          echo "Error: scripts/download_quantized_model.py not found!"
          ls -R  # This will list all files to help you see where it is
          exit 1
        fi

    - name: Run linting
      run: |
        poetry run black --check src tests
        poetry run isort --check-only src tests
        poetry run flake8 src tests
        poetry run mypy src 

    - name: Run unit tests
      run: |
        poetry run python -m pytest tests/unit -v --cov=src --cov-report=xml

    - name: Run integration tests
      run: |
        poetry run pytest tests/integration -v --cov-append

    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml

  train-model:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python & Poetry
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}

    - name: Download SGCC Dataset
      run: |
        poetry install --only main
        # In production, fetch from secure data lake
        poetry run python scripts/download_data.py --dataset sgcc --output data/raw/

    - name: Feature Engineering
      run: |
        poetry run python -m src.pipeline.data_pipeline \
          --input data/raw/sgcc.csv \
          --output data/processed/features.parquet \
          --extract-tsfresh

    - name: Train Hybrid Model
      run: |
        poetry run python scripts/train_models.py \
          --features data/processed/features.parquet \
          --model-output models/hybrid_detector.joblib \
          --metrics-output models/metrics.json

    - name: Quantize SLM
      run: |
        poetry run python scripts/quantize_llm.py \
          --base-model microsoft/Phi-3-mini-4k-instruct \
          --quantization gguf-Q4_K_M \
          --output models/phi-3-theft-detector.gguf

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: model-artifacts
        path: |
          models/hybrid_detector.joblib
          models/metrics.json
          models/phi-3-theft-detector.gguf

  drift-detection:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * *'
    steps:
    - uses: actions/checkout@v4

    - name: Set up environment
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        pip install poetry
        poetry install --only main

    - name: Run Drift Detection
      run: |
        poetry run python scripts/monitor_drift.py \
          --reference data/drift_reference/ \
          --current data/production/current_features.parquet \
          --output reports/drift_report.json

    - name: Alert on Drift
      if: failure()
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "ðŸš¨ Data Drift Detected in Electricity Theft Detection Pipeline",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "Significant distribution shift detected. Model retraining recommended."
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  build-and-push:
    needs: [ test, train-model ]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4

    - name: Set lower case repo name
      run: |
        echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

    - name: Download Model Artifacts
      uses: actions/download-artifact@v4
      with:
        name: model-artifacts
        path: models/

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push API image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile.api
        push: true
        tags: |
          # 2. UPDATED: Use the new ENV variable instead of github.repository
          ghcr.io/${{ env.REPO_LOWER }}/theft-detection-api:${{ github.sha }}
          ghcr.io/${{ env.REPO_LOWER }}/theft-detection-api:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push training image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile.training
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/theft-detection-training:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max